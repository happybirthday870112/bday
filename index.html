<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yoshi's Birthday Party</title>
    <style>
        /* --- 基礎設定 --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #333;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            overflow: hidden; /* 禁止網頁捲動 */
            touch-action: none; /* 禁止手機預設觸控行為 */
            user-select: none; /* 禁止長按選取文字(消除藍色框) */
            -webkit-user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-stage {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 480px; /* 手機直式比例 */
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%);
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* --- UI 介面 --- */
        .ui-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 1000;
            text-align: center;
            transition: opacity 0.3s;
        }
        .hidden { display: none !important; }
        
        h1 { color: #4CAF50; font-size: 24px; margin: 10px; text-shadow: 1px 1px 0 #fff; }
        p { color: #555; font-size: 16px; margin: 10px 30px; line-height: 1.6; }
        
        .btn {
            background: #ff9800; color: white; border: none;
            padding: 12px 40px; font-size: 20px; border-radius: 50px;
            cursor: pointer; box-shadow: 0 4px #e65100; margin-top: 20px;
            font-weight: bold;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px #e65100; }

        /* 進度條 */
        .progress-bar { display: flex; gap: 8px; margin-bottom: 20px; }
        .egg-icon { 
            width: 30px; height: 35px; 
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/f/f1/Yoshi_Egg.svg/1200px-Yoshi_Egg.svg.png');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            filter: grayscale(100%); opacity: 0.3; transition: all 0.5s;
        }
        .egg-icon.active { filter: grayscale(0%); opacity: 1; transform: scale(1.2); }

        /* --- 遊戲物件通用設定 --- */
        .sprite {
            position: absolute;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none; /* 讓點擊穿透，由 JS 處理邏輯 */
            z-index: 10; /* 確保在最上層 */
        }
        
        /* 針對特定遊戲的修正 */
        #ground {
            position: absolute; bottom: 0; width: 100%; height: 40px;
            background: #5D4037; border-top: 5px solid #4CAF50; z-index: 5;
        }

        /* G3 舌頭 */
        .tongue-line {
            position: absolute; height: 10px; background: #FF4081;
            border-radius: 5px; transform-origin: left center; z-index: 9;
        }

        /* G6 終點線 */
        .finish-line {
            position: absolute; top: 80px; width: 100%; height: 10px;
            background: repeating-linear-gradient(to right, white, white 20px, black 20px, black 40px);
            z-index: 4;
        }

        /* 蛋糕頁面 */
        .cake-container {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; background: #FFF3E0;
        }
        .final-msg {
            font-size: 28px; color: #E91E63; font-weight: bold; margin-top: 20px;
            animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    </style>
</head>
<body>

    <div id="game-stage">
        <div id="game-layer" style="width:100%; height:100%; position:relative;"></div>

        <div id="ui-layer" class="ui-screen">
            <h1 id="ui-title">載入中...</h1>
            <div id="progress-area" class="progress-bar hidden">
                <div class="egg-icon" id="egg-1"></div>
                <div class="egg-icon" id="egg-2"></div>
                <div class="egg-icon" id="egg-3"></div>
                <div class="egg-icon" id="egg-4"></div>
                <div class="egg-icon" id="egg-5"></div>
                <div class="egg-icon" id="egg-6"></div>
            </div>
            <p id="ui-desc">正在準備派對...</p>
            <button id="ui-btn" class="btn">開始遊戲</button>
        </div>
    </div>

    <script>
        // --- 圖片素材庫 (可替換網址) ---
        // 使用網路上較穩定的 Wiki 圖片資源
        const ASSETS = {
            yoshi: "https://upload.wikimedia.org/wikipedia/en/3/39/YoshiMarioParty10.png", // 站立
            yoshiRun: "https://mario.wiki.gallery/images/thumb/a/a2/Yoshi_-_Mario_Party_10.png/260px-Yoshi_-_Mario_Party_10.png", // 跑步/動作
            melon: "https://mario.wiki.gallery/images/thumb/d/db/Melon_Yoshi_Story.png/120px-Melon_Yoshi_Story.png",
            bomb: "https://mario.wiki.gallery/images/7/73/Bob-omb_Mario_Party_Superstars.png",
            shyGuy: "https://mario.wiki.gallery/images/thumb/a/a3/Shy_Guy_-_Mario_Party_10.png/180px-Shy_Guy_-_Mario_Party_10.png",
            egg: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f1/Yoshi_Egg.svg/1200px-Yoshi_Egg.svg.png",
            bowser: "https://mario.wiki.gallery/images/thumb/6/67/Bowser_-_Mario_Party_10.png/250px-Bowser_-_Mario_Party_10.png",
            basketRed: "https://cdn-icons-png.flaticon.com/512/2929/2929486.png", // 紅籃子示意
            basketGreen: "https://cdn-icons-png.flaticon.com/512/2929/2929506.png"  // 綠籃子示意
        };

        // --- 系統變數 ---
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = parseInt(urlParams.get('game'));
        const stage = document.getElementById('game-layer');
        const ui = document.getElementById('ui-layer');
        const uiTitle = document.getElementById('ui-title');
        const uiDesc = document.getElementById('ui-desc');
        const uiBtn = document.getElementById('ui-btn');
        let loopId = null;
        let isPlaying = false;
        
        // 遊戲狀態容器
        let state = { score: 0, timer: 0, objects: [], player: null };

        // --- 初始化 ---
        function init() {
            checkProgress();
            
            if (!gameId) {
                showDashboard();
            } else if (gameId >= 1 && gameId <= 6) {
                showIntro(gameId);
            } else {
                alert("無效的遊戲 ID");
            }
        }

        // 檢查進度
        function checkProgress() {
            for(let i=1; i<=6; i++) {
                if(localStorage.getItem('yoshi_gift_'+i)) {
                    const el = document.getElementById('egg-'+i);
                    if(el) el.classList.add('active');
                }
            }
        }

        function isAllCleared() {
            let c = 0;
            for(let i=1; i<=6; i++) if(localStorage.getItem('yoshi_gift_'+i)) c++;
            return c === 6;
        }

        // 顯示主選單
        function showDashboard() {
            document.getElementById('progress-area').classList.remove('hidden');
            uiTitle.innerText = "耀西的生日冒險";
            
            if (isAllCleared()) {
                uiDesc.innerText = "六顆蛋都收集齊了！\n準備好迎接驚喜了嗎？";
                uiBtn.innerText = "打開禮物";
                uiBtn.onclick = launchSurprise;
            } else {
                uiDesc.innerText = "目前收集進度\n請掃描卡片遊玩關卡";
                uiBtn.style.display = 'none';
            }
        }

        // 顯示關卡介紹
        function showIntro(id) {
            const texts = [
                {t:"1. 耀西跳跳", d:"點擊螢幕讓耀西跳起來，\n躲避水管堅持 15 秒！"},
                {t:"2. 哈密瓜接接樂", d:"左右滑動移動耀西，\n接住哈密瓜(綠)，避開炸彈(黑)。\n目標：10分"},
                {t:"3. 舌頭快手", d:"看到紅色嘿荷出現時，\n點擊它伸舌頭攻擊！\n目標：8隻"},
                {t:"4. 孵蛋大作戰", d:"狂點螢幕中央的蛋，\n直到它孵化為止！\n目標：連點 30 次"},
                {t:"5. 顏色分類", d:"把紅色耀西拖到紅籃子，\n綠色耀西拖到綠籃子。\n目標：10隻"},
                {t:"6. 一二三木頭人", d:"按住螢幕耀西會往上跑，\n庫巴生氣(變紅)時立刻放手！\n目標：抵達終點"}
            ];
            uiTitle.innerText = texts[id-1].t;
            uiDesc.innerText = texts[id-1].d;
            uiBtn.innerText = "開始";
            uiBtn.onclick = () => { ui.classList.add('hidden'); startGame(id); };
        }

        function win() {
            isPlaying = false;
            cancelAnimationFrame(loopId);
            localStorage.setItem('yoshi_gift_'+gameId, 'true');
            ui.classList.remove('hidden');
            uiTitle.innerText = "過關！";
            uiDesc.innerText = "獲得了一顆耀西蛋！";
            uiBtn.innerText = "回到主畫面";
            uiBtn.onclick = () => window.location.href = window.location.pathname;
        }

        function lose() {
            isPlaying = false;
            cancelAnimationFrame(loopId);
            ui.classList.remove('hidden');
            uiTitle.innerText = "失敗...";
            uiDesc.innerText = "再試一次吧！";
            uiBtn.innerText = "重試";
            uiBtn.onclick = () => { ui.classList.add('hidden'); startGame(gameId); };
        }

        // --- 核心遊戲引擎 ---
        function startGame(id) {
            stage.innerHTML = ''; // 清空場景
            state = { score: 0, timer: 0, objects: [], player: null };
            isPlaying = true;

            if(id === 1) game1();
            if(id === 2) game2();
            if(id === 3) game3();
            if(id === 4) game4();
            if(id === 5) game5();
            if(id === 6) game6();
        }

        // 輔助：建立圖片精靈
        function createSprite(url, w, h, x, y) {
            const img = document.createElement('div');
            img.className = 'sprite';
            img.style.backgroundImage = `url('${url}')`;
            img.style.width = w + 'px';
            img.style.height = h + 'px';
            img.style.left = x + 'px';
            img.style.top = y + 'px';
            stage.appendChild(img);
            return img;
        }

        // ================= 各關卡邏輯 (修正版) =================

        // --- G1: 跳躍 (修正：重力與位置) ---
        function game1() {
            const groundY = stage.clientHeight - 60;
            const player = createSprite(ASSETS.yoshiRun, 60, 60, 50, groundY);
            let vy = 0;
            let y = groundY;
            let onGround = true;

            // 地板裝飾
            const ground = document.createElement('div');
            ground.id = 'ground';
            stage.appendChild(ground);

            // 跳躍事件
            document.body.onpointerdown = (e) => {
                if(onGround && isPlaying) {
                    vy = -13; // 跳躍力道
                    onGround = false;
                    player.style.backgroundImage = `url('${ASSETS.yoshi}')`; // 換圖
                }
            };

            function loop() {
                if(!isPlaying) return;
                state.timer++;

                // 物理
                vy += 0.8; // 重力
                y += vy;
                if(y > groundY) {
                    y = groundY;
                    vy = 0;
                    onGround = true;
                    player.style.backgroundImage = `url('${ASSETS.yoshiRun}')`;
                }
                player.style.top = y + 'px';

                // 生成障礙 (水管)
                if(state.timer % 100 === 0) {
                    const h = Math.random() * 80 + 50;
                    const pipe = document.createElement('div');
                    pipe.style.cssText = `position:absolute; bottom:40px; left:100%; width:50px; height:${h}px; background:#2E7D32; border:2px solid #1B5E20; z-index:5;`;
                    // 水管頭
                    const cap = document.createElement('div');
                    cap.style.cssText = `position:absolute; top:-20px; left:-5px; width:60px; height:20px; background:#2E7D32; border:2px solid #1B5E20;`;
                    pipe.appendChild(cap);
                    stage.appendChild(pipe);
                    state.objects.push({el: pipe, x: 100});
                }

                // 障礙移動
                state.objects.forEach((obj, i) => {
                    obj.x -= 1.5; // 移動速度
                    obj.el.style.left = obj.x + '%';

                    // 碰撞檢測
                    const pRect = player.getBoundingClientRect();
                    const oRect = obj.el.getBoundingClientRect();
                    
                    // 簡單縮小碰撞框避免誤判
                    if(pRect.right-10 > oRect.left && pRect.left+10 < oRect.right && pRect.bottom-5 > oRect.top) {
                        lose();
                    }

                    if(obj.x < -20) {
                        obj.el.remove();
                        state.objects.splice(i, 1);
                    }
                });

                if(state.timer > 60 * 15) win(); // 15秒
                else loopId = requestAnimationFrame(loop);
            }
            loop();
        }

        // --- G2: 接哈密瓜 (修正：速度與操控) ---
        function game2() {
            const playerY = stage.clientHeight - 80;
            const player = createSprite(ASSETS.yoshi, 60, 60, stage.clientWidth/2 - 30, playerY);
            let playerX = stage.clientWidth/2 - 30;
            
            // 觸控跟隨
            stage.onpointermove = (e) => {
                if(!isPlaying) return;
                e.preventDefault();
                const rect = stage.getBoundingClientRect();
                let x = e.clientX - rect.left - 30; // 減去一半寬度置中
                // 限制範圍
                if(x < 0) x = 0;
                if(x > stage.clientWidth - 60) x = stage.clientWidth - 60;
                playerX = x;
                player.style.left = playerX + 'px';
            };

            function loop() {
                if(!isPlaying) return;
                
                // 生成掉落物 (降低頻率)
                if(Math.random() < 0.02) {
                    const isBomb = Math.random() < 0.3;
                    const item = createSprite(isBomb ? ASSETS.bomb : ASSETS.melon, 40, 40, Math.random() * (stage.clientWidth - 40), -50);
                    state.objects.push({el: item, y: -50, type: isBomb});
                }

                state.objects.forEach((obj, i) => {
                    obj.y += 3; // 降低掉落速度
                    obj.el.style.top = obj.y + 'px';

                    // 碰撞
                    const pRect = player.getBoundingClientRect();
                    const iRect = obj.el.getBoundingClientRect();

                    if(pRect.top < iRect.bottom && pRect.bottom > iRect.top && 
                       pRect.left < iRect.right && pRect.right > iRect.left) {
                        
                        obj.el.remove();
                        state.objects.splice(i, 1);
                        
                        if(obj.type) lose(); // 炸彈
                        else {
                            state.score++;
                            // 視覺反饋
                            player.style.transform = 'scale(1.2)';
                            setTimeout(()=>player.style.transform='scale(1)', 100);
                            if(state.score >= 10) win();
                        }
                    } else if (obj.y > stage.clientHeight) {
                        obj.el.remove();
                        state.objects.splice(i, 1);
                    }
                });

                loopId = requestAnimationFrame(loop);
            }
            loop();
        }

        // --- G3: 舌頭 (修正：加上視覺線條) ---
        function game3() {
            const player = createSprite(ASSETS.yoshi, 70, 70, stage.clientWidth/2 - 35, stage.clientHeight - 80);
            
            function spawnEnemy() {
                if(!isPlaying) return;
                const enemy = createSprite(ASSETS.shyGuy, 50, 50, Math.random() * (stage.clientWidth - 60), Math.random() * (stage.clientHeight/2) + 50);
                
                // 點擊事件
                enemy.onpointerdown = (e) => {
                    e.stopPropagation(); // 防止連點
                    attack(enemy);
                };

                // 2秒後消失
                setTimeout(() => {
                    if(enemy.parentNode) {
                        enemy.remove();
                        if(isPlaying) spawnEnemy();
                    }
                }, 2000);
            }

            function attack(target) {
                // 畫舌頭
                const tongue = document.createElement('div');
                tongue.className = 'tongue-line';
                stage.appendChild(tongue);

                // 計算座標
                const startX = player.offsetLeft + 35;
                const startY = player.offsetTop + 20;
                const endX = target.offsetLeft + 25;
                const endY = target.offsetTop + 25;

                const dx = endX - startX;
                const dy = endY - startY;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;

                tongue.style.left = startX + 'px';
                tongue.style.top = startY + 'px';
                tongue.style.width = dist + 'px';
                tongue.style.transform = `rotate(${angle}deg)`;

                // 擊中效果
                target.remove();
                state.score++;
                
                setTimeout(() => tongue.remove(), 150); // 收回舌頭
                
                if(state.score >= 8) win();
                else setTimeout(spawnEnemy, 500);
            }

            spawnEnemy();
        }

        // --- G4: 孵蛋 (修正：去除藍框，換成圖片) ---
        function game4() {
            const egg = createSprite(ASSETS.egg, 120, 150, stage.clientWidth/2 - 60, stage.clientHeight/2 - 75);
            let clicks = 0;

            // 重要：取消瀏覽器默認行為
            egg.onpointerdown = (e) => {
                e.preventDefault(); 
                clicks++;
                
                // 震動與變大
                egg.style.transform = `scale(${1 + clicks/50}) rotate(${Math.random()*10-5}deg)`;
                
                if(clicks >= 30) {
                    // 孵化動畫
                    egg.style.transition = 'all 0.5s';
                    egg.style.opacity = 0;
                    egg.style.transform = 'scale(2)';
                    
                    // 耀西出現
                    setTimeout(() => {
                        const yoshi = createSprite(ASSETS.yoshiRun, 100, 100, stage.clientWidth/2 - 50, stage.clientHeight/2 - 50);
                        yoshi.animate([
                            { transform: 'scale(0) translateY(50px)' },
                            { transform: 'scale(1.5) translateY(-50px)' },
                            { transform: 'scale(1) translateY(0)' }
                        ], { duration: 800 });
                        setTimeout(win, 1000);
                    }, 300);
                }
            };
        }

        // --- G5: 顏色分類 (修正：拖曳邏輯) ---
        function game5() {
            // 籃子
            const basketR = createSprite(ASSETS.basketRed, 80, 80, 20, stage.clientHeight - 100);
            const basketG = createSprite(ASSETS.basketGreen, 80, 80, stage.clientWidth - 100, stage.clientHeight - 100);
            
            function spawnYoshi() {
                if(!isPlaying) return;
                const isGreen = Math.random() > 0.5;
                const y = createSprite(isGreen ? ASSETS.yoshi : ASSETS.yoshiRun, 60, 60, stage.clientWidth/2 - 30, 50);
                
                // 強制改色 (CSS filter)
                if(!isGreen) y.style.filter = "hue-rotate(140deg)"; // 紅色耀西

                let isDragging = false;
                
                y.onpointerdown = (e) => {
                    e.preventDefault();
                    isDragging = true;
                    y.setPointerCapture(e.pointerId);
                };

                y.onpointermove = (e) => {
                    if(!isDragging) return;
                    e.preventDefault();
                    // 讓圖片跟隨手指中心
                    y.style.left = (e.clientX - stage.getBoundingClientRect().left - 30) + 'px';
                    y.style.top = (e.clientY - stage.getBoundingClientRect().top - 30) + 'px';
                };

                y.onpointerup = (e) => {
                    isDragging = false;
                    const rect = y.getBoundingClientRect();
                    const bR = basketR.getBoundingClientRect();
                    const bG = basketG.getBoundingClientRect();

                    let correct = false;
                    // 判定紅籃
                    if(!isGreen && isOverlap(rect, bR)) correct = true;
                    // 判定綠籃
                    if(isGreen && isOverlap(rect, bG)) correct = true;

                    if(correct) {
                        y.remove();
                        state.score++;
                        if(state.score >= 10) win();
                        else spawnYoshi();
                    } else {
                        // 錯誤彈回
                        y.style.left = (stage.clientWidth/2 - 30) + 'px';
                        y.style.top = '50px';
                    }
                };
            }
            
            function isOverlap(r1, r2) {
                return !(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom);
            }

            spawnYoshi();
        }

        // --- G6: 木頭人 (修正：垂直卷軸) ---
        function game6() {
            // 終點線
            const line = document.createElement('div');
            line.className = 'finish-line';
            stage.appendChild(line);

            // 庫巴 (上方)
            const bowser = createSprite(ASSETS.bowser, 100, 100, stage.clientWidth/2 - 50, 10);
            
            // 耀西 (下方)
            const yoshi = createSprite(ASSETS.yoshi, 60, 60, stage.clientWidth/2 - 30, stage.clientHeight - 80);
            
            let progress = 0;
            let isMoving = false;
            let isAngry = false; // 庫巴生氣狀態
            let nextStateTime = performance.now() + 2000;

            // 按住螢幕移動
            stage.onpointerdown = (e) => { e.preventDefault(); isMoving = true; };
            stage.onpointerup = (e) => { e.preventDefault(); isMoving = false; };

            function loop(time) {
                if(!isPlaying) return;

                // 庫巴邏輯
                if(time > nextStateTime) {
                    isAngry = !isAngry;
                    // 視覺改變
                    if(isAngry) {
                        bowser.style.filter = "sepia(1) saturate(5) hue-rotate(-50deg)"; // 變紅
                        bowser.style.transform = "scale(1.1)";
                    } else {
                        bowser.style.filter = "none";
                        bowser.style.transform = "scale(1)";
                    }
                    nextStateTime = time + (isAngry ? 1500 : 2000); // 生氣短一點，背對久一點
                }

                // 玩家邏輯
                if(isMoving) {
                    if(isAngry) {
                        lose(); // 動了就輸
                        return;
                    }
                    progress += 1.5; // 前進速度
                    yoshi.style.backgroundImage = `url('${ASSETS.yoshiRun}')`;
                } else {
                    yoshi.style.backgroundImage = `url('${ASSETS.yoshi}')`;
                }

                // 更新位置 (由下往上)
                const startY = stage.clientHeight - 80;
                const endY = 100; // 庫巴位置
                const currentY = startY - progress;
                
                yoshi.style.top = currentY + 'px';

                if(currentY <= endY) win();
                else loopId = requestAnimationFrame(loop);
            }
            loopId = requestAnimationFrame(loop);
        }

        // --- 最終驚喜 ---
        function launchSurprise() {
            stage.innerHTML = `
                <div class="cake-container">
                    <img src="https://mario.wiki.gallery/images/thumb/e/e0/Yoshi_Series_Emblem.svg/1200px-Yoshi_Series_Emblem.svg.png" width="200">
                    <div class="final-msg">
                        阿癱<br>お誕生日おめでとう！
                    </div>
                </div>
            `;
            // 撒花特效
            for(let i=0; i<50; i++) {
                const conf = document.createElement('div');
                conf.style.cssText = `position:absolute; width:10px; height:10px; background:${['#f00','#0f0','#00f'][Math.floor(Math.random()*3)]}; top:-10px; left:${Math.random()*100}%;`;
                stage.appendChild(conf);
                conf.animate([
                    {transform: `translateY(0) rotate(0deg)`, opacity:1},
                    {transform: `translateY(${window.innerHeight}px) rotate(720deg)`, opacity:0}
                ], {
                    duration: 2000 + Math.random()*2000,
                    iterations: Infinity
                });
            }
        }

        init();
    </script>
</body>
</html>
