<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Yoshi Egg Birthday – Mini Games</title>
  <style>
    :root{
      --bg1:#0c1116; --bg2:#101a24;
      --card:#121a22; --line:#243241;
      --txt:#e7f0ff; --muted:#9fb2c7;
      --green:#41d36a; --green2:#2aa94d;
      --cream:#f3f0e9; --spot:#36c55e;
      --danger:#ff5470; --gold:#ffd35a;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial;}
    body{background: radial-gradient(1200px 800px at 20% 10%, #17324a 0%, var(--bg1) 45%, #070a0e 100%); color:var(--txt); overscroll-behavior:none;}
    a{color:inherit}
    .wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .phone{
      width:min(420px, 100%);
      aspect-ratio: 9/16;
      max-height: calc(100vh - 32px);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 26px;
      overflow:hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      position:relative;
      display:flex;
      flex-direction:column;
      touch-action: manipulation;
    }
    .topbar{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(8px);
    }
    .title{font-weight:800; letter-spacing:.3px; font-size:14px;}
    .sub{font-size:12px; color:var(--muted); margin-left:auto; display:flex; align-items:center; gap:8px;}
    .eggs{display:flex; gap:4px; align-items:center;}
    .eggDot{
      width:10px; height:14px; border-radius: 9px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.08);
      position:relative; overflow:hidden;
    }
    .eggDot.done{background: linear-gradient(180deg, rgba(65,211,106,.8), rgba(42,169,77,.8)); border-color: rgba(65,211,106,.65);}
    .main{flex:1; padding:14px; position:relative;}
    .card{
      height:100%;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .row{display:flex; gap:12px; align-items:center;}
    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:10px 12px; border-radius: 12px;
      background: rgba(255,255,255,.10);
      color:var(--txt);
      border:1px solid rgba(255,255,255,.14);
      font-weight:700;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(65,211,106,.95), rgba(42,169,77,.95));
      border-color: rgba(65,211,106,.65);
      color:#04200d;
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,84,112,.92), rgba(208,38,64,.92));
      border-color: rgba(255,84,112,.6);
      color:#240007;
    }
    .hint{font-size:12px; color:var(--muted); line-height:1.5;}
    .h1{font-size:18px; font-weight:900; margin:0;}
    .spacer{height:10px;}
    .center{display:flex; align-items:center; justify-content:center;}
    .hud{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-top:8px;
      font-size:12px; color:var(--muted);
    }
    .pill{
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      display:inline-flex; gap:8px; align-items:center;
      color:var(--txt);
      font-weight:700;
    }

    /* —— CSS 幾何風「小恐龍」(致敬感，不用官方素材) —— */
    .yoshi{
      width:84px; height:84px; position:relative;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
      flex:0 0 auto;
    }
    .yoshi .head{
      position:absolute; left:10px; top:10px;
      width:56px; height:50px; border-radius: 26px;
      background: linear-gradient(180deg, var(--green), var(--green2));
    }
    .yoshi .snout{
      position:absolute; left:34px; top:28px;
      width:44px; height:34px; border-radius: 18px;
      background: linear-gradient(180deg, #52ea80, #2fb85a);
      transform: rotate(-6deg);
    }
    .yoshi .belly{
      position:absolute; left:18px; top:44px;
      width:44px; height:34px; border-radius: 18px;
      background: linear-gradient(180deg, #ffffff, #dde6ef);
      opacity:.95;
    }
    .yoshi .eye{
      position:absolute; top:18px;
      width:12px; height:18px; border-radius: 10px;
      background: rgba(255,255,255,.95);
    }
    .yoshi .eye::after{
      content:""; position:absolute; left:3px; top:6px;
      width:6px; height:8px; border-radius: 6px;
      background:#0c1016;
    }
    .yoshi .eye.left{left:20px}
    .yoshi .eye.right{left:34px}
    .yoshi .spike{
      position:absolute; right:6px; top:34px;
      width:20px; height:20px; border-radius: 10px;
      background: linear-gradient(180deg, #ff6b7f, #e23b58);
      transform: rotate(18deg);
    }
    .yoshi .shoe{
      position:absolute; bottom:0;
      width:30px; height:16px; border-radius: 12px;
      background: linear-gradient(180deg, #ffb04d, #ff7f2e);
    }
    .yoshi .shoe.left{left:12px}
    .yoshi .shoe.right{left:40px}

    /* —— 介面用「耀西蛋」元素 —— */
    .egg{
      width:120px; height:160px; border-radius: 999px;
      background: radial-gradient(circle at 40% 20%, rgba(255,255,255,.9), var(--cream) 55%, #d8d2c7 100%);
      border: 2px solid rgba(255,255,255,.35);
      position:relative;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      overflow:hidden;
      user-select:none;
      touch-action: manipulation;
    }
    .spot{position:absolute; border-radius: 999px; background: rgba(54,197,94,.92); filter: blur(.2px);}
    .spot.s1{width:44px;height:58px; left:20px; top:34px;}
    .spot.s2{width:30px;height:36px; right:20px; top:62px;}
    .spot.s3{width:56px;height:42px; left:34px; bottom:20px;}
    .crack{
      position:absolute; inset:0; pointer-events:none;
      background:
        linear-gradient(transparent 0 0),
        repeating-linear-gradient(135deg, rgba(0,0,0,0) 0 18px, rgba(0,0,0,.26) 18px 19px, rgba(0,0,0,0) 19px 40px);
      opacity:0;
      mix-blend-mode:multiply;
      transform: translateY(-6px);
      transition: opacity .12s ease;
    }

    /* overlay */
    .overlay{
      position:absolute; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
    }
    .overlay.show{display:flex}
    .modal{
      width:100%;
      background: rgba(10,14,18,.92);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      padding:14px;
    }
    .modal h2{margin:0 0 6px; font-size:16px}
    .modal p{margin:0 0 12px; color:var(--muted); font-size:12px; line-height:1.6}
    .grid{display:grid; gap:10px;}
    .two{grid-template-columns: 1fr 1fr;}
    .badge{font-size:12px; font-weight:900; color: var(--gold);}

    /* game canvases */
    .arena{
      position:relative;
      height: 66%;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      touch-action:none;
    }
    .lane{
      position:absolute; top:0; bottom:0;
      width:33.333%;
      border-right:1px solid rgba(255,255,255,.06);
    }
    .lane:last-child{border-right:0}
    .obj{
      position:absolute;
      width:22px; height:22px; border-radius: 999px;
      background: rgba(255,211,90,.92);
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
    }
    .obj.bad{background: rgba(255,84,112,.92)}
    .player{
      position:absolute; bottom:10px; left:50%;
      transform: translateX(-50%);
      width:58px; height:16px;
      border-radius: 999px;
      background: rgba(65,211,106,.85);
      border:1px solid rgba(65,211,106,.55);
    }
    .player::after{
      content:"";
      position:absolute; left:50%; top:-34px; transform: translateX(-50%);
      width:42px; height:42px; border-radius: 14px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(6px);
    }

    /* memory cards */
    .cards{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;}
    .cardBtn{
      position:relative;
      height:64px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      overflow:hidden;
      cursor:pointer;
    }
    .cardBtn.revealed{background: rgba(65,211,106,.20); border-color: rgba(65,211,106,.38)}
    .cardBtn.matched{background: rgba(255,211,90,.16); border-color: rgba(255,211,90,.35)}
    .cardFace{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      font-weight:900; letter-spacing:.5px;
    }
    .pattern{
      width:34px; height:44px; border-radius: 999px;
      background: rgba(243,240,233,.95);
      border:1px solid rgba(255,255,255,.35);
      position:relative;
    }
    .pattern::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 40% 30%, rgba(54,197,94,.92) 0 10px, transparent 11px),
        radial-gradient(circle at 65% 55%, rgba(54,197,94,.92) 0 8px, transparent 9px),
        radial-gradient(circle at 45% 78%, rgba(54,197,94,.92) 0 12px, transparent 13px);
      opacity:.85;
    }
    /* subtle variation via data-k */
    .pattern[data-k="2"]::after{filter:hue-rotate(30deg)}
    .pattern[data-k="3"]::after{filter:hue-rotate(70deg)}
    .pattern[data-k="4"]::after{filter:hue-rotate(-30deg)}
    .pattern[data-k="5"]::after{filter:hue-rotate(-60deg)}
    .pattern[data-k="6"]::after{filter:hue-rotate(110deg)}

    /* sliding puzzle */
    .puzzle{display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;}
    .tile{
      height:72px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:center;
      font-weight:1000;
      user-select:none;
    }
    .tile.empty{background: rgba(255,255,255,.03); border-style:dashed; color:transparent;}

    /* simon egg */
    .simonEgg{
      width:220px; height:290px;
      border-radius: 999px;
      margin: 0 auto;
      background: radial-gradient(circle at 40% 20%, rgba(255,255,255,.92), var(--cream) 55%, #d8d2c7 100%);
      border:2px solid rgba(255,255,255,.30);
      position:relative;
      overflow:hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      touch-action: manipulation;
    }
    .sDot{
      position:absolute;
      border-radius:999px;
      background: rgba(54,197,94,.35);
      border:1px solid rgba(54,197,94,.35);
      cursor:pointer;
      transition: transform .08s ease, background .08s ease;
    }
    .sDot.on{background: rgba(54,197,94,.95); transform: scale(1.05);}
    .sDot.d1{width:52px;height:64px; left:44px; top:54px;}
    .sDot.d2{width:36px;height:44px; right:54px; top:90px;}
    .sDot.d3{width:64px;height:50px; left:74px; top:150px;}
    .sDot.d4{width:40px;height:40px; right:78px; top:176px;}
    .sDot.d5{width:46px;height:56px; left:42px; top:192px;}

    /* prevent highlight */
    button, .cardBtn, .egg, .sDot{ -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="phone" id="phone">
      <div class="topbar">
        <div class="yoshi" aria-hidden="true">
          <div class="head"></div>
          <div class="snout"></div>
          <div class="belly"></div>
          <div class="eye left"></div>
          <div class="eye right"></div>
          <div class="spike"></div>
          <div class="shoe left"></div>
          <div class="shoe right"></div>
        </div>
        <div>
          <div class="title" id="gameTitle">Mini Game</div>
          <div class="hint" id="gameDesc">點擊開始</div>
        </div>
        <div class="sub">
          <span class="badge" id="progressText">0/6</span>
          <div class="eggs" id="eggs"></div>
        </div>
      </div>

      <div class="main">
        <div class="card" id="root"></div>

        <div class="overlay" id="overlay">
          <div class="modal">
            <h2 id="ovTitle">完成！</h2>
            <p id="ovDesc">你獲得了一片蛋糕碎片。去掃下一張卡吧。</p>
            <div class="grid two">
              <button class="btn" id="btnBack">回到選單</button>
              <button class="btn primary" id="btnNext">下一關</button>
            </div>
            <div class="spacer"></div>
            <button class="btn danger" id="btnReset" title="測試用">重置進度（測試）</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => [...el.querySelectorAll(s)];
  const phone = $("#phone");
  const root = $("#root");
  const overlay = $("#overlay");
  const gameTitle = $("#gameTitle");
  const gameDesc = $("#gameDesc");
  const eggsEl = $("#eggs");
  const progressText = $("#progressText");

  // Avoid page scroll on mobile while playing
  phone.addEventListener("touchmove", (e) => e.preventDefault(), { passive:false });

  const KEY_PREFIX = "yoshiGift_g";
  const getDone = (i) => localStorage.getItem(KEY_PREFIX + i) === "1";
  const setDone = (i) => localStorage.setItem(KEY_PREFIX + i, "1");
  const clearAll = () => { for(let i=1;i<=6;i++) localStorage.removeItem(KEY_PREFIX+i); };

  function renderProgress(){
    eggsEl.innerHTML = "";
    let doneCount = 0;
    for(let i=1;i<=6;i++){
      const d = getDone(i);
      if(d) doneCount++;
      const dot = document.createElement("div");
      dot.className = "eggDot" + (d ? " done" : "");
      dot.title = d ? `第${i}關：已完成` : `第${i}關：未完成`;
      eggsEl.appendChild(dot);
    }
    progressText.textContent = `${doneCount}/6`;
  }

  // Swipe helper: left/right only (Pointer Events; works with touch/mouse)
  function bindSwipe(el, onLeft, onRight){
    let sx=0, sy=0, down=false, pid=null;
    const TH = 30;
    el.addEventListener("pointerdown", (e)=>{
      down=true; sx=e.clientX; sy=e.clientY; pid=e.pointerId;
      el.setPointerCapture?.(pid);
    });
    el.addEventListener("pointerup", (e)=>{
      if(!down) return;
      down=false;
      const dx = e.clientX - sx;
      const dy = e.clientY - sy;
      if(Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > TH){
        dx < 0 ? onLeft?.() : onRight?.();
      }
    });
    el.addEventListener("pointercancel", ()=>{ down=false; });
  }

  const GAMES = [
    {
      id: 1,
      title: "① 敲敲蛋殼",
      desc: "在時間內連點蛋殼達到目標次數。",
      init: (host, win) => {
        host.innerHTML = `
          <div class="row">
            <div>
              <p class="h1">敲敲蛋殼</p>
              <p class="hint">點擊蛋殼，把它敲出裂痕。達到 <b id="goal">24</b> 下就過關。</p>
              <div class="hud">
                <span class="pill">剩餘：<b id="t">8.0</b>s</span>
                <span class="pill">點擊：<b id="c">0</b></span>
              </div>
            </div>
          </div>
          <div class="spacer"></div>
          <div class="center">
            <div class="egg" id="egg" role="button" aria-label="敲蛋">
              <div class="spot s1"></div><div class="spot s2"></div><div class="spot s3"></div>
              <div class="crack" id="crack"></div>
            </div>
          </div>
          <div class="spacer"></div>
          <button class="btn primary" id="start">開始</button>
        `;
        const egg = $("#egg", host);
        const crack = $("#crack", host);
        const btn = $("#start", host);
        const tEl = $("#t", host), cEl = $("#c", host);
        const GOAL = 24;
        $("#goal", host).textContent = GOAL;

        let running=false, clicks=0, startAt=0, raf=0;
        function stop(){ running=false; cancelAnimationFrame(raf); }
        function loop(){
          const now = performance.now();
          const left = Math.max(0, 8 - (now - startAt)/1000);
          tEl.textContent = left.toFixed(1);
          if(left<=0){
            stop();
            if(clicks>=GOAL) win();
            else { btn.textContent="再試一次"; btn.disabled=false; }
            return;
          }
          raf = requestAnimationFrame(loop);
        }

        egg.addEventListener("click", ()=>{
          if(!running) return;
          clicks++;
          cEl.textContent = clicks;
          crack.style.opacity = Math.min(1, clicks/GOAL * 1.05);
          crack.style.transform = `translateY(${-(6 - Math.min(6, clicks/6))}px)`;
          if(clicks>=GOAL){
            stop();
            win();
          }
        });

        btn.addEventListener("click", ()=>{
          clicks=0; cEl.textContent="0";
          crack.style.opacity=0; crack.style.transform="translateY(-6px)";
          btn.disabled=true;
          btn.textContent="進行中…";
          running=true;
          startAt = performance.now();
          raf = requestAnimationFrame(loop);
        });
      }
    },
    {
      id: 2,
      title: "② 水果接接樂",
      desc: "左右滑動換跑道，接到指定水果數量。",
      init: (host, win) => {
        host.innerHTML = `
          <p class="h1">水果接接樂</p>
          <p class="hint">左右滑動切換 3 條跑道。接到 <b id="goal">12</b> 顆就過關。</p>
          <div class="hud">
            <span class="pill">時間：<b id="t">20</b>s</span>
            <span class="pill">接到：<b id="ok">0</b></span>
            <span class="pill">漏掉：<b id="miss">0</b>/5</span>
          </div>
          <div class="spacer"></div>
          <div class="arena" id="arena">
            <div class="lane" style="left:0%"></div>
            <div class="lane" style="left:33.333%"></div>
            <div class="lane" style="left:66.666%"></div>
            <div class="player" id="player"></div>
          </div>
          <div class="spacer"></div>
          <button class="btn primary" id="start">開始</button>
        `;
        const arena = $("#arena", host);
        const player = $("#player", host);
        const btn = $("#start", host);
        const tEl = $("#t", host), okEl = $("#ok", host), missEl = $("#miss", host);
        const GOAL = 12, LIMIT = 5;
        $("#goal", host).textContent = GOAL;

        let lane=1, running=false;
        let ok=0, miss=0;
        let objs=[];
        let startAt=0, lastSpawn=0, raf=0;

        function setLane(n){
          lane = Math.max(0, Math.min(2, n));
          player.style.left = (16.666 + lane*33.333) + "%";
        }
        bindSwipe(arena, ()=>setLane(lane-1), ()=>setLane(lane+1));

        function spawn(){
          const o = document.createElement("div");
          o.className="obj";
          const l = Math.floor(Math.random()*3);
          o.dataset.lane = String(l);
          o.style.left = (12 + l*33.333) + "%";
          o.style.top = "-24px";
          arena.appendChild(o);
          objs.push({el:o, y:-24, lane:l, v: 220 + Math.random()*120});
        }
        function stop(){ running=false; cancelAnimationFrame(raf); }
        function resetUI(){
          ok=0; miss=0; okEl.textContent="0"; missEl.textContent="0";
          $$(".obj", arena).forEach(n=>n.remove());
          objs=[];
          setLane(1);
        }

        function loop(){
          const now = performance.now();
          const dt = 1/60;
          const left = Math.max(0, 20 - (now-startAt)/1000);
          tEl.textContent = left.toFixed(0);

          if(now - lastSpawn > 520){
            lastSpawn = now;
            spawn();
          }

          const rect = arena.getBoundingClientRect();
          const pX = rect.width*(0.16666 + lane*0.33333);
          const pY = rect.height - 18;

          objs.forEach(o=>{
            o.y += o.v*dt;
            o.el.style.top = o.y + "px";

            if(o.y > rect.height + 30){
              o.el.remove();
              o.dead = true;
              miss++; missEl.textContent = miss;
            }else{
              // simple hit check
              const oX = rect.width*(0.16666 + o.lane*0.33333);
              const dx = Math.abs(oX - pX);
              const dy = Math.abs(o.y - (pY-40));
              if(dx < 26 && dy < 26){
                o.el.remove();
                o.dead = true;
                ok++; okEl.textContent = ok;
              }
            }
          });
          objs = objs.filter(o=>!o.dead);

          if(ok>=GOAL){ stop(); win(); return; }
          if(miss>=LIMIT || left<=0){
            stop();
            if(ok>=GOAL) win();
            else { btn.textContent="再試一次"; btn.disabled=false; }
            return;
          }
          raf = requestAnimationFrame(loop);
        }

        btn.addEventListener("click", ()=>{
          resetUI();
          btn.disabled=true;
          btn.textContent="進行中…（可左右滑）";
          running=true;
          startAt=performance.now();
          lastSpawn=startAt;
          raf = requestAnimationFrame(loop);
        });
      }
    },
    {
      id: 3,
      title: "③ 蛋花記憶翻牌",
      desc: "點擊翻牌，配對相同花紋。",
      init: (host, win) => {
        host.innerHTML = `
          <p class="h1">蛋花記憶翻牌</p>
          <p class="hint">點擊翻牌，看看蛋殼花紋。配對完成 6 組就過關。</p>
          <div class="hud">
            <span class="pill">配對：<b id="m">0</b>/6</span>
            <span class="pill">失誤：<b id="e">0</b></span>
          </div>
          <div class="spacer"></div>
          <div class="cards" id="cards"></div>
          <div class="spacer"></div>
          <button class="btn primary" id="restart">重新洗牌</button>
        `;
        const cardsEl = $("#cards", host);
        const mEl = $("#m", host), eEl = $("#e", host);
        const restart = $("#restart", host);
        let first=null, lock=false, matched=0, errors=0;

        function shuffled(arr){
          const a=[...arr];
          for(let i=a.length-1;i>0;i--){
            const j=Math.floor(Math.random()*(i+1));
            [a[i],a[j]]=[a[j],a[i]];
          }
          return a;
        }

        function build(){
          cardsEl.innerHTML="";
          first=null; lock=false; matched=0; errors=0;
          mEl.textContent="0"; eEl.textContent="0";
          const keys = [1,2,3,4,5,6];
          const deck = shuffled([...keys, ...keys]);
          deck.forEach((k, idx)=>{
            const btn = document.createElement("button");
            btn.className="cardBtn";
            btn.dataset.k=String(k);
            btn.innerHTML = `
              <div class="cardFace">?</div>
              <div class="cardFace" style="opacity:0">
                <div class="pattern" data-k="${k}"></div>
              </div>`;
            btn.addEventListener("click", ()=>{
              if(lock || btn.classList.contains("matched") || btn===first) return;
              reveal(btn, true);
              if(!first){ first=btn; return; }
              // second
              const k1=first.dataset.k, k2=btn.dataset.k;
              if(k1===k2){
                first.classList.add("matched");
                btn.classList.add("matched");
                matched++;
                mEl.textContent=String(matched);
                first=null;
                if(matched>=6) win();
              }else{
                errors++; eEl.textContent=String(errors);
                lock=true;
                setTimeout(()=>{
                  reveal(first,false);
                  reveal(btn,false);
                  first=null;
                  lock=false;
                }, 520);
              }
            });
            cardsEl.appendChild(btn);
          });
        }
        function reveal(btn, on){
          btn.classList.toggle("revealed", on);
          const faces = $$(".cardFace", btn);
          faces[0].style.opacity = on ? "0" : "1";
          faces[1].style.opacity = on ? "1" : "0";
        }
        restart.addEventListener("click", build);
        build();
      }
    },
    {
      id: 4,
      title: "④ 三線躲躲樂",
      desc: "左右滑動換跑道，撐過時間就過關。",
      init: (host, win) => {
        host.innerHTML = `
          <p class="h1">三線躲躲樂</p>
          <p class="hint">左右滑動換跑道，避開紅色障礙。撐過 <b id="goal">18</b> 秒就過關。</p>
          <div class="hud">
            <span class="pill">剩餘：<b id="t">18</b>s</span>
            <span class="pill">狀態：<b id="s">待開始</b></span>
          </div>
          <div class="spacer"></div>
          <div class="arena" id="arena">
            <div class="lane" style="left:0%"></div>
            <div class="lane" style="left:33.333%"></div>
            <div class="lane" style="left:66.666%"></div>
            <div class="player" id="player"></div>
          </div>
          <div class="spacer"></div>
          <button class="btn primary" id="start">開始</button>
        `;
        const arena = $("#arena", host);
        const player = $("#player", host);
        const btn = $("#start", host);
        const tEl = $("#t", host), sEl=$("#s", host);
        const GOAL = 18;
        $("#goal", host).textContent = GOAL;

        let lane=1, running=false, raf=0, startAt=0, lastSpawn=0;
        let obs=[];

        function setLane(n){
          lane = Math.max(0, Math.min(2, n));
          player.style.left = (16.666 + lane*33.333) + "%";
        }
        bindSwipe(arena, ()=>setLane(lane-1), ()=>setLane(lane+1));

        function spawn(){
          const o=document.createElement("div");
          o.className="obj bad";
          const l=Math.floor(Math.random()*3);
          o.dataset.lane=String(l);
          o.style.left = (12 + l*33.333) + "%";
          o.style.top="-28px";
          arena.appendChild(o);
          obs.push({el:o, y:-28, lane:l, v: 260 + Math.random()*160});
        }

        function stop(){ running=false; cancelAnimationFrame(raf); }
        function reset(){
          $$(".obj.bad", arena).forEach(n=>n.remove());
          obs=[];
          setLane(1);
        }

        function loop(){
          const now=performance.now();
          const rect=arena.getBoundingClientRect();
          const left = Math.max(0, GOAL - (now-startAt)/1000);
          tEl.textContent = left.toFixed(0);

          if(now-lastSpawn > 540){
            lastSpawn=now;
            spawn();
          }

          // move + collision
          const pX = rect.width*(0.16666 + lane*0.33333);
          const pY = rect.height - 18;

          obs.forEach(o=>{
            o.y += o.v*(1/60);
            o.el.style.top = o.y + "px";

            if(o.y > rect.height + 40){
              o.el.remove(); o.dead=true;
            }else{
              const oX = rect.width*(0.16666 + o.lane*0.33333);
              const dx = Math.abs(oX - pX);
              const dy = Math.abs(o.y - (pY-40));
              if(dx < 24 && dy < 22){
                // hit
                sEl.textContent="撞到啦";
                stop();
                btn.textContent="再試一次";
                btn.disabled=false;
              }
            }
          });
          obs = obs.filter(o=>!o.dead);

          if(!running) return;
          if(left<=0){
            stop();
            win();
            return;
          }
          raf=requestAnimationFrame(loop);
        }

        btn.addEventListener("click", ()=>{
          reset();
          btn.disabled=true;
          btn.textContent="進行中…（可左右滑）";
          sEl.textContent="生存中";
          running=true;
          startAt=performance.now();
          lastSpawn=startAt;
          raf=requestAnimationFrame(loop);
        });
      }
    },
    {
      id: 5,
      title: "⑤ 滑塊拼圖",
      desc: "左右滑動移動方塊，還原 1~8。",
      init: (host, win) => {
        host.innerHTML = `
          <p class="h1">滑塊拼圖</p>
          <p class="hint">點擊方塊，或在拼圖區左右滑動，把 1~8 排回去。完成就過關。</p>
          <div class="hud">
            <span class="pill">步數：<b id="steps">0</b></span>
            <span class="pill">提示：空格旁的方塊能移動</span>
          </div>
          <div class="spacer"></div>
          <div class="puzzle" id="puzzle"></div>
          <div class="spacer"></div>
          <button class="btn primary" id="shuffle">重新打亂</button>
        `;
        const puzzle = $("#puzzle", host);
        const stepsEl = $("#steps", host);
        const shuffleBtn = $("#shuffle", host);

        let state = [1,2,3,4,5,6,7,8,0];
        let steps = 0;

        function render(){
          puzzle.innerHTML="";
          state.forEach((v, idx)=>{
            const d=document.createElement("div");
            d.className="tile" + (v===0 ? " empty":"");
            d.textContent = v===0 ? "" : String(v);
            d.dataset.idx = String(idx);
            d.addEventListener("click", ()=> tryMove(idx));
            puzzle.appendChild(d);
          });
          stepsEl.textContent=String(steps);
        }

        function isSolved(){
          for(let i=0;i<8;i++) if(state[i]!==i+1) return false;
          return state[8]===0;
        }

        function neighbors(i){
          const r=Math.floor(i/3), c=i%3;
          const n=[];
          if(c>0) n.push(i-1);
          if(c<2) n.push(i+1);
          if(r>0) n.push(i-3);
          if(r<2) n.push(i+3);
          return n;
        }

        function tryMove(i){
          const z = state.indexOf(0);
          if(!neighbors(z).includes(i)) return;
          [state[z], state[i]]=[state[i], state[z]];
          steps++;
          render();
          if(isSolved()) win();
        }

        function shuffle(){
          // simple random valid moves
          state=[1,2,3,4,5,6,7,8,0];
          steps=0;
          for(let k=0;k<80;k++){
            const z=state.indexOf(0);
            const ns=neighbors(z);
            const pick=ns[Math.floor(Math.random()*ns.length)];
            [state[z], state[pick]]=[state[pick], state[z]];
          }
          render();
        }

        // swipe left/right = try move tile into empty horizontally
        bindSwipe(puzzle,
          ()=>{ // left swipe
            const z=state.indexOf(0);
            const c=z%3;
            if(c<2) tryMove(z+1); // move right tile into empty
          },
          ()=>{ // right swipe
            const z=state.indexOf(0);
            const c=z%3;
            if(c>0) tryMove(z-1);
          }
        );

        shuffleBtn.addEventListener("click", shuffle);
        shuffle();
      }
    },
    {
      id: 6,
      title: "⑥ 蛋點西蒙",
      desc: "看點點亮起順序，照順序點回去。",
      init: (host, win) => {
        host.innerHTML = `
          <p class="h1">蛋點西蒙</p>
          <p class="hint">先看蛋上的點點亮起順序，再照順序點回去。完成 5 步序列就過關。</p>
          <div class="hud">
            <span class="pill">關卡：<b id="lvl">1</b>/5</span>
            <span class="pill">狀態：<b id="st">準備</b></span>
          </div>
          <div class="spacer"></div>
          <div class="simonEgg" id="egg">
            <div class="sDot d1" data-i="1"></div>
            <div class="sDot d2" data-i="2"></div>
            <div class="sDot d3" data-i="3"></div>
            <div class="sDot d4" data-i="4"></div>
            <div class="sDot d5" data-i="5"></div>
          </div>
          <div class="spacer"></div>
          <button class="btn primary" id="start">開始</button>
        `;
        const egg = $("#egg", host);
        const dots = $$(".sDot", egg);
        const startBtn = $("#start", host);
        const lvlEl = $("#lvl", host);
        const stEl = $("#st", host);

        const seq=[];
        let input=[];
        let lvl=1;
        let phase="idle"; // show / input

        const sleep = (ms) => new Promise(r=>setTimeout(r, ms));
        const flash = async (i) => {
          const d = dots.find(x=>x.dataset.i===String(i));
          d.classList.add("on");
          await sleep(260);
          d.classList.remove("on");
          await sleep(120);
        };

        async function showSeq(){
          phase="show";
          stEl.textContent="記住順序";
          startBtn.disabled=true;
          for(const i of seq) await flash(i);
          phase="input";
          stEl.textContent="換你點";
          startBtn.disabled=false;
        }

        function addStep(){
          const next = 1 + Math.floor(Math.random()*5);
          seq.push(next);
          input=[];
          lvlEl.textContent = String(lvl);
        }

        function reset(){
          seq.length=0; input=[];
          lvl=1;
          lvlEl.textContent="1";
          stEl.textContent="準備";
        }

        dots.forEach(d=>{
          d.addEventListener("click", async ()=>{
            if(phase!=="input") return;
            const i = Number(d.dataset.i);
            d.classList.add("on");
            setTimeout(()=>d.classList.remove("on"), 140);

            input.push(i);
            // check
            for(let k=0;k<input.length;k++){
              if(input[k]!==seq[k]){
                stEl.textContent="錯了，重來";
                reset();
                return;
              }
            }
            if(input.length===seq.length){
              if(lvl>=5){ win(); return; }
              lvl++;
              addStep();
              await sleep(220);
              await showSeq();
            }
          });
        });

        startBtn.addEventListener("click", async ()=>{
          if(phase==="show") return;
          if(seq.length===0) addStep();
          await showSeq();
        });

        reset();
      }
    }
  ];

  function showMenu(){
    gameTitle.textContent = "六張卡片・六個小關卡";
    gameDesc.textContent = "掃描 QR Code 進入對應關卡。完成 6 關就能解鎖蛋糕。";
    renderProgress();

    const doneCount = GAMES.reduce((a,g)=>a+(getDone(g.id)?1:0),0);

    root.innerHTML = `
      <p class="h1">給阿癱的生日任務</p>
      <p class="hint">每張卡片是一個小遊戲（只要點擊＆左右滑動）。六關全過，去打開蛋糕頁！</p>
      <div class="spacer"></div>
      <div class="row">
        <div class="pill">目前進度：<b>${doneCount}</b>/6</div>
        <a class="btn" href="final.html">前往蛋糕頁</a>
      </div>
      <div class="spacer"></div>
      <div class="grid" style="gap:10px">
        ${GAMES.map(g=>{
          const d = getDone(g.id);
          return `
            <a class="btn ${d?'':'primary'}" href="?g=${g.id}">
              ${d?'✅':'▶︎'} ${g.title}
            </a>
          `;
        }).join("")}
      </div>
      <div class="spacer"></div>
      <p class="hint">（測試用）如果你要重新玩：<button class="btn danger" id="wipe">清除進度</button></p>
    `;
    $("#wipe", root).addEventListener("click", ()=>{
      clearAll();
      showMenu();
    });
  }

  function showOverlay(gameId){
    renderProgress();
    $("#ovTitle").textContent = "完成！你拿到一片蛋糕碎片";
    $("#ovDesc").textContent = "去掃下一張卡，或按下一關繼續。";
    overlay.classList.add("show");

    $("#btnBack").onclick = () => { overlay.classList.remove("show"); showMenu(); };
    $("#btnReset").onclick = () => { clearAll(); overlay.classList.remove("show"); showMenu(); };

    const nextId = gameId < 6 ? gameId+1 : 0;
    const btnNext = $("#btnNext");
    if(nextId){
      btnNext.textContent = "下一關";
      btnNext.onclick = () => location.href = `?g=${nextId}`;
    }else{
      btnNext.textContent = "去蛋糕頁";
      btnNext.onclick = () => location.href = "final.html";
    }
  }

  function loadGame(id){
    const g = GAMES.find(x=>x.id===id);
    if(!g){ showMenu(); return; }

    gameTitle.textContent = g.title;
    gameDesc.textContent = g.desc;
    renderProgress();

    const win = () => {
      setDone(id);
      showOverlay(id);
    };

    g.init(root, win);
  }

  // boot
  const url = new URL(location.href);
  const id = Number(url.searchParams.get("g") || "0");
  loadGame(id);
})();
</script>
</body>
</html>