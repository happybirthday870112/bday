<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Birthday Mini Games</title>
  <style>
    :root{
      --bg1:#0c1116; --txt:#e7f0ff; --muted:#9fb2c7;
      --card:rgba(0,0,0,.20); --line:rgba(255,255,255,.12);
      --green:#41d36a; --green2:#2aa94d; --danger:#ff5470; --gold:#ffd35a;
      --egg-src: "egg.png";
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial;}
    body{background: radial-gradient(1200px 800px at 20% 10%, #17324a 0%, var(--bg1) 45%, #070a0e 100%); color:var(--txt); overscroll-behavior:none;}
    .wrap{height:100%; display:flex; align-items:center; justify-content:center; padding:16px;}
    .phone{
      width:min(420px,100%); aspect-ratio:9/16; max-height:calc(100vh - 32px);
      border-radius:26px; overflow:hidden; position:relative; display:flex; flex-direction:column;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line); box-shadow:0 20px 60px rgba(0,0,0,.45);
      touch-action: manipulation;
    }
    .topbar{
      padding:12px 14px; display:flex; align-items:center; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22); backdrop-filter: blur(8px);
    }
    .eggLogo{width:46px; height:46px; image-rendering: pixelated; border-radius:12px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); padding:6px;}
    .title{font-weight:1000; font-size:14px; letter-spacing:.3px;}
    .hint{font-size:12px; color:var(--muted); line-height:1.55; margin:0;}
    .sub{margin-left:auto; display:flex; align-items:center; gap:10px;}
    .badge{font-size:12px; font-weight:1000; color:var(--gold);}
    .eggs{display:flex; gap:4px; align-items:center;}
    .eggDot{width:10px; height:14px; border-radius:9px; border:1px solid rgba(255,255,255,.25); background: rgba(255,255,255,.08);}
    .eggDot.done{background: linear-gradient(180deg, rgba(65,211,106,.8), rgba(42,169,77,.8)); border-color: rgba(65,211,106,.65);}
    .main{flex:1; padding:14px; position:relative;}
    .card{
      height:100%; background: var(--card); border:1px solid rgba(255,255,255,.10);
      border-radius:18px; padding:14px; position:relative; overflow:hidden;
    }
    .h1{margin:0; font-size:18px; font-weight:1000;}
    .spacer{height:10px;}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .pill{
      padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08); display:inline-flex; gap:8px; align-items:center;
      color:var(--txt); font-weight:900; font-size:12px;
    }
    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:10px 12px; border-radius:12px; font-weight:1000;
      background: rgba(255,255,255,.10); color:var(--txt);
      border:1px solid rgba(255,255,255,.14);
      text-decoration:none; display:inline-flex; align-items:center; justify-content:center;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(65,211,106,.95), rgba(42,169,77,.95));
      border-color: rgba(65,211,106,.65); color:#04200d;
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,84,112,.92), rgba(208,38,64,.92));
      border-color: rgba(255,84,112,.6); color:#240007;
    }

    /* arenas */
    .arena{
      position:relative; height:66%; border-radius:16px; overflow:hidden;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.05);
      touch-action: none;
    }
    .lane{position:absolute; top:0; bottom:0; width:33.333%; border-right:1px solid rgba(255,255,255,.06);}
    .lane:last-child{border-right:0}
    .player{
      position:absolute; bottom:10px; left:50%; transform: translateX(-50%);
      width:70px; height:18px; border-radius:999px;
      background: rgba(65,211,106,.70); border:1px solid rgba(65,211,106,.55);
    }

    /* falling objects with emoji fruit */
    .obj{
      position:absolute; width:30px; height:30px; border-radius:999px;
      background: rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.18);
      display:flex; align-items:center; justify-content:center;
      font-size:18px; box-shadow: 0 10px 18px rgba(0,0,0,.25);
      user-select:none;
    }

    /* Game 1 egg */
    .bigEgg{
      width:140px; height:180px; border-radius:999px;
      border:2px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      user-select:none;
    }
    .bigEgg img{width:86px; height:86px; image-rendering: pixelated;}
    .crack{position:absolute; inset:0; pointer-events:none; opacity:0; transition:opacity .12s ease;
      background: repeating-linear-gradient(135deg, rgba(0,0,0,0) 0 18px, rgba(0,0,0,.26) 18px 19px, rgba(0,0,0,0) 19px 40px);
      mix-blend-mode:multiply;
    }

    /* Memory flip: detailed egg patterns */
    .cards{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;}
    .cardBtn{height:66px; border-radius:14px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.08); cursor:pointer; position:relative; overflow:hidden;}
    .cardBtn.revealed{background: rgba(65,211,106,.16); border-color: rgba(65,211,106,.32)}
    .cardBtn.matched{background: rgba(255,211,90,.14); border-color: rgba(255,211,90,.32)}
    .face{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:1000;}
    .eggMini{
      width:34px; height:44px; border-radius:999px;
      border:1px solid rgba(255,255,255,.35);
      background:
        radial-gradient(circle at 35% 22%, rgba(255,255,255,.92) 0 14px, transparent 15px),
        radial-gradient(circle at 40% 34%, rgba(54,197,94,.92) 0 6px, transparent 7px),
        radial-gradient(circle at 62% 48%, rgba(54,197,94,.92) 0 5px, transparent 6px),
        radial-gradient(circle at 46% 70%, rgba(54,197,94,.92) 0 7px, transparent 8px),
        radial-gradient(circle at 70% 74%, rgba(54,197,94,.92) 0 4px, transparent 5px),
        linear-gradient(180deg, rgba(243,240,233,.96), rgba(210,206,198,.96));
      box-shadow: 0 8px 16px rgba(0,0,0,.20);
    }
    /* slight variations by hue shift */
    .eggMini[data-k="2"]{filter:hue-rotate(24deg)}
    .eggMini[data-k="3"]{filter:hue-rotate(60deg)}
    .eggMini[data-k="4"]{filter:hue-rotate(-22deg)}
    .eggMini[data-k="5"]{filter:hue-rotate(-46deg)}
    .eggMini[data-k="6"]{filter:hue-rotate(100deg)}

    /* Game 4 targets */
    .target{
      position:absolute; width:44px; height:44px; border-radius:14px;
      background: rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.16);
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 14px 22px rgba(0,0,0,.25);
      cursor:pointer;
    }
    .target img{width:28px; height:28px; image-rendering: pixelated;}

    /* Game 5 drop */
    .dropEgg{
      position:absolute; top:10px; left:50%; transform: translateX(-50%);
      width:44px; height:44px; border-radius:14px;
      background: rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.16);
      display:flex; align-items:center; justify-content:center;
    }
    .dropEgg img{width:28px; height:28px; image-rendering: pixelated;}
    .basket{
      position:absolute; bottom:12px; left:50%;
      width:88px; height:22px; transform: translateX(-50%);
      border-radius:999px;
      background: rgba(255,211,90,.22);
      border:1px solid rgba(255,211,90,.36);
    }
    .fallingEgg{
      position:absolute; width:30px; height:30px; border-radius:12px;
      background: rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.16);
      display:flex; align-items:center; justify-content:center;
    }
    .fallingEgg img{width:20px; height:20px; image-rendering: pixelated;}

    /* Game 6 red light green light */
    .signal{
      display:flex; align-items:center; justify-content:space-between;
      border:1px solid rgba(255,255,255,.12); border-radius:16px;
      padding:10px 12px; background: rgba(255,255,255,.06);
    }
    .lamp{
      width:90px; height:36px; border-radius:999px; display:flex; align-items:center; justify-content:center;
      font-weight:1000; letter-spacing:.6px;
      border:1px solid rgba(255,255,255,.14);
    }
    .lamp.go{background: rgba(65,211,106,.22); border-color: rgba(65,211,106,.35); color: var(--green);}
    .lamp.stop{background: rgba(255,84,112,.18); border-color: rgba(255,84,112,.32); color: var(--danger);}
    .track{
      width:100%; height:16px; border-radius:999px; background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12); overflow:hidden;
    }
    .bar{height:100%; width:0%; background: linear-gradient(90deg, rgba(65,211,106,.9), rgba(255,211,90,.85));}
    .runner{
      margin-top:10px;
      display:flex; align-items:center; justify-content:center; gap:10px;
      color:var(--muted); font-size:12px;
    }
    .runner img{width:26px; height:26px; image-rendering: pixelated;}

    /* overlay */
    .overlay{
      position:absolute; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:18px;
    }
    .overlay.show{display:flex}
    .modal{
      width:100%; background: rgba(10,14,18,.92);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px; padding:14px;
    }
    .modal h2{margin:0 0 6px; font-size:16px}
    .modal p{margin:0 0 12px; color:var(--muted); font-size:12px; line-height:1.6}
    .grid{display:grid; gap:10px;}
    .two{grid-template-columns:1fr 1fr;}
    button, .cardBtn, .arena, .target{ -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="phone" id="phone">
    <div class="topbar">
      <img class="eggLogo" id="logoEgg" alt="egg" />
      <div>
        <div class="title" id="gameTitle">Mini Game</div>
        <p class="hint" id="gameDesc">é»æ“Šé–‹å§‹</p>
      </div>
      <div class="sub">
        <span class="badge" id="progressText">0/6</span>
        <div class="eggs" id="eggs"></div>
      </div>
    </div>

    <div class="main">
      <div class="card" id="root"></div>

      <div class="overlay" id="overlay">
        <div class="modal">
          <h2 id="ovTitle">å®Œæˆï¼</h2>
          <p id="ovDesc">ä½ ç²å¾—äº†ä¸€ç‰‡è›‹ç³•ç¢ç‰‡ã€‚</p>
          <div class="grid two">
            <button class="btn" id="btnBack">å›åˆ°é¸å–®</button>
            <button class="btn primary" id="btnNext">ä¸‹ä¸€é—œ</button>
          </div>
          <div class="spacer"></div>
          <button class="btn danger" id="btnReset" title="æ¸¬è©¦ç”¨">é‡ç½®é€²åº¦ï¼ˆæ¸¬è©¦ï¼‰</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => [...el.querySelectorAll(s)];

  const EGG_SRC = "egg.png"; // <- ä½ æŠŠåƒç´ è›‹ä¸Šå‚³ä¸¦å‘½åæˆé€™å€‹
  $("#logoEgg").src = EGG_SRC;

  const phone = $("#phone");
  const root = $("#root");
  const overlay = $("#overlay");
  const gameTitle = $("#gameTitle");
  const gameDesc = $("#gameDesc");
  const eggsEl = $("#eggs");
  const progressText = $("#progressText");

  // prevent scroll while playing
  phone.addEventListener("touchmove", (e) => e.preventDefault(), { passive:false });

  const KEY_PREFIX = "yoshiGift_g";
  const getDone = (i) => localStorage.getItem(KEY_PREFIX + i) === "1";
  const setDone = (i) => localStorage.setItem(KEY_PREFIX + i, "1");
  const clearAll = () => { for(let i=1;i<=6;i++) localStorage.removeItem(KEY_PREFIX+i); };

  function renderProgress(){
    eggsEl.innerHTML = "";
    let doneCount = 0;
    for(let i=1;i<=6;i++){
      const d = getDone(i);
      if(d) doneCount++;
      const dot = document.createElement("div");
      dot.className = "eggDot" + (d ? " done" : "");
      eggsEl.appendChild(dot);
    }
    progressText.textContent = `${doneCount}/6`;
  }

  // Swipe helper (left/right)
  function bindSwipe(el, onLeft, onRight){
    let sx=0, sy=0, down=false, pid=null;
    const TH = 28;
    el.addEventListener("pointerdown", (e)=>{
      down=true; sx=e.clientX; sy=e.clientY; pid=e.pointerId;
      el.setPointerCapture?.(pid);
    });
    el.addEventListener("pointerup", (e)=>{
      if(!down) return;
      down=false;
      const dx = e.clientX - sx;
      const dy = e.clientY - sy;
      if(Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > TH){
        dx < 0 ? onLeft?.() : onRight?.();
      }
    });
    el.addEventListener("pointercancel", ()=>{ down=false; });
  }

  const GAMES = [
    // â‘  æ•²æ•²è›‹æ®¼ï¼ˆä¿ç•™ï¼‰
    {
      id: 1,
      title: "â‘  æ•²æ•²è›‹æ®¼",
      desc: "åœ¨æ™‚é–“å…§é€£é»è›‹æ®¼é”åˆ°ç›®æ¨™æ¬¡æ•¸ã€‚",
      init: (host, win) => {
        host.innerHTML = `
          <p class="h1">æ•²æ•²è›‹æ®¼</p>
          <p class="hint">é»æ“Šè›‹æ®¼æŠŠå®ƒæ•²è£‚ã€‚é”åˆ° <b id="goal">22</b> ä¸‹å°±éé—œã€‚</p>
          <div class="row">
            <span class="pill">å‰©é¤˜ï¼š<b id="t">8.0</b>s</span>
            <span class="pill">é»æ“Šï¼š<b id="c">0</b></span>
          </div>
          <div class="spacer"></div>
          <div style="display:flex; justify-content:center; position:relative;">
            <div class="bigEgg" id="egg" role="button" aria-label="æ•²è›‹">
              <img src="${EGG_SRC}" alt="egg" />
              <div class="crack" id="crack"></div>
            </div>
          </div>
          <div class="spacer"></div>
          <button class="btn primary" id="start">é–‹å§‹</button>
        `;
        const egg = $("#egg", host);
        const crack = $("#crack", host);
        const btn = $("#start", host);
        const tEl = $("#t", host), cEl = $("#c", host);
        const GOAL = 22;
        $("#goal", host).textContent = GOAL;

        let running=false, clicks=0, startAt=0, raf=0;
        function stop(){ running=false; cancelAnimationFrame(raf); }
        function loop(){
          const now = performance.now();
          const left = Math.max(0, 8 - (now - startAt)/1000);
          tEl.textContent = left.toFixed(1);
          if(left<=0){
            stop();
            if(clicks>=GOAL) win();
            else { btn.textContent="å†è©¦ä¸€æ¬¡"; btn.disabled=false; }
            return;
          }
          raf = requestAnimationFrame(loop);
        }

        egg.addEventListener("click", ()=>{
          if(!running) return;
          clicks++;
          cEl.textContent = clicks;
          crack.style.opacity = Math.min(1, clicks/GOAL * 1.1);
          if(clicks>=GOAL){ stop(); win(); }
        });

        btn.addEventListener("click", ()=>{
          clicks=0; cEl.textContent="0";
          crack.style.opacity=0;
          btn.disabled=true; btn.textContent="é€²è¡Œä¸­â€¦";
          running=true; startAt=performance.now();
          raf = requestAnimationFrame(loop);
        });
      }
    },

    // â‘¡ æ°´æœæ¥æ¥æ¨‚ï¼ˆåŠ æ°´æœ + é™é€Ÿï¼‰
    {
      id: 2,
      title: "â‘¡ æ°´æœæ¥æ¥æ¨‚",
      desc: "å·¦å³æ»‘å‹•æ›è·‘é“ï¼Œæ¥åˆ°æŒ‡å®šæ°´æœæ•¸é‡ã€‚",
      init: (host, win) => {
        host.innerHTML = `
          <p class="h1">æ°´æœæ¥æ¥æ¨‚</p>
          <p class="hint">å·¦å³æ»‘å‹•åˆ‡æ› 3 æ¢è·‘é“ã€‚æ¥åˆ° <b id="goal">10</b> é¡†å°±éé—œï¼›æ¼æ‰å¤ªå¤šæœƒå¤±æ•—ã€‚</p>
          <div class="row">
            <span class="pill">æ™‚é–“ï¼š<b id="t">25</b>s</span>
            <span class="pill">æ¥åˆ°ï¼š<b id="ok">0</b></span>
            <span class="pill">æ¼æ‰ï¼š<b id="miss">0</b>/8</span>
          </div>
          <div class="spacer"></div>
          <div class="arena" id="arena">
            <div class="lane" style="left:0%"></div>
            <div class="lane" style="left:33.333%"></div>
            <div class="lane" style="left:66.666%"></div>
            <div class="player" id="player"></div>
          </div>
          <div class="spacer"></div>
          <button class="btn primary" id="start">é–‹å§‹</button>
        `;
        const arena = $("#arena", host);
        const player = $("#player", host);
        const btn = $("#start", host);
        const tEl = $("#t", host), okEl = $("#ok", host), missEl = $("#miss", host);
        const GOAL = 10, LIMIT = 8;
        $("#goal", host).textContent = GOAL;

        const FRUITS = ["ğŸ","ğŸŒ","ğŸ‡","ğŸ“","ğŸ","ğŸ‘"];
        let lane=1, running=false;
        let ok=0, miss=0;
        let objs=[];
        let startAt=0, lastSpawn=0, raf=0;

        function setLane(n){
          lane = Math.max(0, Math.min(2, n));
          player.style.left = (16.666 + lane*33.333) + "%";
        }
        bindSwipe(arena, ()=>setLane(lane-1), ()=>setLane(lane+1));

        function spawn(){
          const o = document.createElement("div");
          o.className="obj";
          o.textContent = FRUITS[Math.floor(Math.random()*FRUITS.length)];
          const l = Math.floor(Math.random()*3);
          o.dataset.lane = String(l);
          o.style.left = (12 + l*33.333) + "%";
          o.style.top = "-34px";
          arena.appendChild(o);
          // é™é€Ÿï¼š140~220
          objs.push({el:o, y:-34, lane:l, v: 140 + Math.random()*80});
        }

        function stop(){ running=false; cancelAnimationFrame(raf); }
        function resetUI(){
          ok=0; miss=0; okEl.textContent="0"; missEl.textContent="0";
          $$(".obj", arena).forEach(n=>n.remove());
          objs=[]; setLane(1);
        }

        function loop(){
          const now = performance.now();
          const left = Math.max(0, 25 - (now-startAt)/1000);
          tEl.textContent = left.toFixed(0);

          // é™ä½ç”Ÿæˆé »ç‡ï¼šç´„æ¯ 760ms ä¸€é¡†
          if(now - lastSpawn > 760){
            lastSpawn = now;
            spawn();
          }

          const rect = arena.getBoundingClientRect();
          const pX = rect.width*(0.16666 + lane*0.33333);
          const pY = rect.height - 18;

          objs.forEach(o=>{
            o.y += o.v*(1/60);
            o.el.style.top = o.y + "px";

            if(o.y > rect.height + 40){
              o.el.remove(); o.dead = true;
              miss++; missEl.textContent = miss;
            }else{
              const oX = rect.width*(0.16666 + o.lane*0.33333);
              const dx = Math.abs(oX - pX);
              const dy = Math.abs(o.y - (pY-40));
              if(dx < 28 && dy < 26){
                o.el.remove(); o.dead = true;
                ok++; okEl.textContent = ok;
              }
            }
          });
          objs = objs.filter(o=>!o.dead);

          if(ok>=GOAL){ stop(); win(); return; }
          if(miss>=LIMIT || left<=0){
            stop();
            if(ok>=GOAL) win();
            else { btn.textContent="å†è©¦ä¸€æ¬¡"; btn.disabled=false; }
            return;
          }
          raf = requestAnimationFrame(loop);
        }

        btn.addEventListener("click", ()=>{
          resetUI();
          btn.disabled=true;
          btn.textContent="é€²è¡Œä¸­â€¦ï¼ˆå¯å·¦å³æ»‘ï¼‰";
          running=true;
          startAt=performance.now();
          lastSpawn=startAt;
          raf = requestAnimationFrame(loop);
        });
      }
    },

    // â‘¢ è›‹èŠ±è¨˜æ†¶ç¿»ç‰Œï¼ˆæ›´ç´°ç·»ï¼‰
    {
      id: 3,
      title: "â‘¢ è›‹èŠ±è¨˜æ†¶ç¿»ç‰Œ",
      desc: "é»æ“Šç¿»ç‰Œï¼Œé…å°ç›¸åŒèŠ±ç´‹ã€‚",
      init: (host, win) => {
        host.innerHTML = `
          <p class="h1">è›‹èŠ±è¨˜æ†¶ç¿»ç‰Œ</p>
          <p class="hint">é»æ“Šç¿»ç‰Œé…å°ã€‚å®Œæˆ 6 çµ„å°±éé—œã€‚</p>
          <div class="row">
            <span class="pill">é…å°ï¼š<b id="m">0</b>/6</span>
            <span class="pill">å¤±èª¤ï¼š<b id="e">0</b></span>
          </div>
          <div class="spacer"></div>
          <div class="cards" id="cards"></div>
          <div class="spacer"></div>
          <button class="btn primary" id="restart">é‡æ–°æ´—ç‰Œ</button>
        `;
        const cardsEl = $("#cards", host);
        const mEl = $("#m", host), eEl = $("#e", host);
        const restart = $("#restart", host);
        let first=null, lock=false, matched=0, errors=0;

        function shuffled(arr){
          const a=[...arr];
          for(let i=a.length-1;i>0;i--){
            const j=Math.floor(Math.random()*(i+1));
            [a[i],a[j]]=[a[j],a[i]];
          }
          return a;
        }

        function build(){
          cardsEl.innerHTML="";
          first=null; lock=false; matched=0; errors=0;
          mEl.textContent="0"; eEl.textContent="0";
          const keys = [1,2,3,4,5,6];
          const deck = shuffled([...keys, ...keys]);

          deck.forEach((k)=>{
            const btn = document.createElement("button");
            btn.className="cardBtn";
            btn.dataset.k=String(k);
            btn.innerHTML = `
              <div class="face f0">?</div>
              <div class="face f1" style="opacity:0">
                <div class="eggMini" data-k="${k}"></div>
              </div>`;
            btn.addEventListener("click", ()=>{
              if(lock || btn.classList.contains("matched") || btn===first) return;
              reveal(btn, true);
              if(!first){ first=btn; return; }
              if(first.dataset.k === btn.dataset.k){
                first.classList.add("matched");
                btn.classList.add("matched");
                matched++; mEl.textContent=String(matched);
                first=null;
                if(matched>=6) win();
              }else{
                errors++; eEl.textContent=String(errors);
                lock=true;
                setTimeout(()=>{
                  reveal(first,false); reveal(btn,false);
                  first=null; lock=false;
                }, 520);
              }
            });
            cardsEl.appendChild(btn);
          });
        }

        function reveal(btn, on){
          btn.classList.toggle("revealed", on);
          const f0 = $(".f0", btn), f1 = $(".f1", btn);
          f0.style.opacity = on ? "0" : "1";
          f1.style.opacity = on ? "1" : "0";
        }

        restart.addEventListener("click", build);
        build();
      }
    },

    // â‘£ æ”¹æˆã€Œè›‹æ®¼æ‰“é¶ã€ï¼ˆä¸å†ä¸‰ç·šèº²èº²ï¼‰
    {
      id: 4,
      title: "â‘£ è›‹æ®¼æ‰“é¶",
      desc: "é»æ“Šå‡ºç¾çš„è›‹ï¼Œé”æ¨™å°±éé—œã€‚",
      init: (host, win) => {
        host.innerHTML = `
          <p class="h1">è›‹æ®¼æ‰“é¶</p>
          <p class="hint">è›‹æœƒåœ¨å ´ä¸Šå†’å‡ºä¾†ã€‚ç”¨é»æ“ŠæŠŠå®ƒæ‰“æ‰ï¼æ‰“ä¸­ <b id="goal">16</b> æ¬¡å°±éé—œã€‚</p>
          <div class="row">
            <span class="pill">å‰©é¤˜ï¼š<b id="t">15</b>s</span>
            <span class="pill">å‘½ä¸­ï¼š<b id="hit">0</b></span>
            <span class="pill">å¤±æ‰‹ï¼š<b id="miss">0</b></span>
          </div>
          <div class="spacer"></div>
          <div class="arena" id="arena"></div>
          <div class="spacer"></div>
          <button class="btn primary" id="start">é–‹å§‹</button>
        `;
        const arena = $("#arena", host);
        const btn = $("#start", host);
        const tEl = $("#t", host), hitEl=$("#hit", host), missEl=$("#miss", host);
        const GOAL = 16;
        $("#goal", host).textContent = GOAL;

        let running=false, startAt=0, raf=0, lastSpawn=0;
        let hit=0, miss=0;

        function clearTargets(){ $$(".target", arena).forEach(n=>n.remove()); }
        function spawn(){
          const rect = arena.getBoundingClientRect();
          const x = 12 + Math.random()*(rect.width - 56);
          const y = 12 + Math.random()*(rect.height - 72);

          const d = document.createElement("div");
          d.className="target";
          d.style.left = x + "px";
          d.style.top  = y + "px";
          d.innerHTML = `<img src="${EGG_SRC}" alt="egg">`;
          arena.appendChild(d);

          const ttl = 900 + Math.random()*500;
          const kill = setTimeout(()=>{ if(d.isConnected){ d.remove(); } }, ttl);

          d.addEventListener("click", (e)=>{
            e.stopPropagation();
            if(!running) return;
            clearTimeout(kill);
            d.remove();
            hit++; hitEl.textContent=hit;
            if(hit>=GOAL){ running=false; cancelAnimationFrame(raf); win(); }
          });
        }

        arena.addEventListener("click", ()=>{
          if(!running) return;
          miss++; missEl.textContent=miss;
        });

        function loop(){
          const now = performance.now();
          const left = Math.max(0, 15 - (now-startAt)/1000);
          tEl.textContent = left.toFixed(0);

          if(now - lastSpawn > 520){
            lastSpawn = now;
            spawn();
          }

          if(left<=0){
            running=false; cancelAnimationFrame(raf);
            if(hit>=GOAL) win();
            else { btn.textContent="å†è©¦ä¸€æ¬¡"; btn.disabled=false; }
            return;
          }
          raf = requestAnimationFrame(loop);
        }

        btn.addEventListener("click", ()=>{
          hit=0; miss=0; hitEl.textContent="0"; missEl.textContent="0";
          clearTargets();
          btn.disabled=true; btn.textContent="é€²è¡Œä¸­â€¦ï¼ˆç‹‚é»ï¼ï¼‰";
          running=true; startAt=performance.now(); lastSpawn=startAt;
          raf = requestAnimationFrame(loop);
        });
      }
    },

    // â‘¤ æ”¹æˆã€ŒæŠ•è›‹å…¥ç±ƒã€ï¼ˆå·¦å³æ»‘å®šä½ + é»æ“ŠæŠ•ä¸‹ï¼‰
    {
      id: 5,
      title: "â‘¤ æŠ•è›‹å…¥ç±ƒ",
      desc: "å·¦å³æ»‘å‹•èª¿ä½ç½®ï¼Œé»æ“ŠæŠ•ä¸‹ï¼Œé€²ç±ƒå¾—åˆ†ã€‚",
      init: (host, win) => {
        host.innerHTML = `
          <p class="h1">æŠ•è›‹å…¥ç±ƒ</p>
          <p class="hint">å·¦å³æ»‘å‹•èª¿æ•´ä¸Šæ–¹è›‹çš„ä½ç½®ï¼Œé»æ“ŠæŠ•ä¸‹ã€‚é€²ç±ƒ <b id="goal">3</b> æ¬¡å°±éé—œã€‚</p>
          <div class="row">
            <span class="pill">å‰©é¤˜ï¼š<b id="t">20</b>s</span>
            <span class="pill">å¾—åˆ†ï¼š<b id="sc">0</b>/3</span>
          </div>
          <div class="spacer"></div>
          <div class="arena" id="arena">
            <div class="dropEgg" id="drop"><img src="${EGG_SRC}" alt="egg"></div>
            <div class="basket" id="basket"></div>
          </div>
          <div class="spacer"></div>
          <button class="btn primary" id="start">é–‹å§‹</button>
        `;
        const arena = $("#arena", host);
        const drop = $("#drop", host);
        const basket = $("#basket", host);
        const btn = $("#start", host);
        const tEl = $("#t", host), scEl=$("#sc", host);
        const GOAL = 3;
        $("#goal", host).textContent = GOAL;

        let running=false, startAt=0, raf=0;
        let dropX = 0.5; // 0..1
        let basketX = 0.5, basketV = 0.22; // moving
        let score=0;

        function setDropByDx(dx){
          const rect = arena.getBoundingClientRect();
          dropX = Math.max(0.08, Math.min(0.92, dropX + dx/rect.width));
          drop.style.left = (dropX*100) + "%";
        }

        bindSwipe(arena, ()=>setDropByDx(-80), ()=>setDropByDx(80));

        function throwEgg(){
          if(!running) return;
          const rect = arena.getBoundingClientRect();
          const e = document.createElement("div");
          e.className="fallingEgg";
          e.style.left = `calc(${dropX*100}% - 15px)`;
          e.style.top = "64px";
          e.innerHTML = `<img src="${EGG_SRC}" alt="egg">`;
          arena.appendChild(e);

          let y = 64;
          const speed = 420; // px/s
          function fall(){
            if(!running){ e.remove(); return; }
            y += speed*(1/60);
            e.style.top = y + "px";

            const by = rect.height - 34;
            if(y >= by){
              // hit check with basket
              const basketLeft = rect.width*(basketX) - 44;
              const eggLeft = rect.width*(dropX) - 15;
              const ok = Math.abs((eggLeft+15) - (basketLeft+44)) < 34;

              e.remove();
              if(ok){
                score++; scEl.textContent = score;
                if(score>=GOAL){ running=false; cancelAnimationFrame(raf); win(); }
              }
              return;
            }
            requestAnimationFrame(fall);
          }
          requestAnimationFrame(fall);
        }

        arena.addEventListener("click", throwEgg);

        function loop(){
          const now = performance.now();
          const left = Math.max(0, 20 - (now-startAt)/1000);
          tEl.textContent = left.toFixed(0);

          // move basket
          basketX += basketV*(1/60);
          if(basketX>0.88){ basketX=0.88; basketV*=-1; }
          if(basketX<0.12){ basketX=0.12; basketV*=-1; }
          basket.style.left = (basketX*100) + "%";

          if(left<=0){
            running=false; cancelAnimationFrame(raf);
            if(score>=GOAL) win();
            else { btn.textContent="å†è©¦ä¸€æ¬¡"; btn.disabled=false; }
            return;
          }
          raf = requestAnimationFrame(loop);
        }

        btn.addEventListener("click", ()=>{
          score=0; scEl.textContent="0";
          $$(".fallingEgg", arena).forEach(n=>n.remove());
          btn.disabled=true; btn.textContent="é€²è¡Œä¸­â€¦ï¼ˆé»æ“ŠæŠ•ä¸‹ï¼‰";
          running=true;
          dropX=0.5; drop.style.left="50%";
          basketX=0.5; basket.style.left="50%";
          startAt=performance.now();
          raf = requestAnimationFrame(loop);
        });
      }
    },

    // â‘¥ æ”¹æˆã€Œä¸€äºŒä¸‰æœ¨é ­äººï¼ˆåº«å·´é¢¨ï¼‰ã€
    {
      id: 6,
      title: "â‘¥ ä¸€äºŒä¸‰æœ¨é ­äºº",
      desc: "ç¶ ç‡ˆæ‰èƒ½å‰é€²ï¼Œç´…ç‡ˆç¢°åˆ°å°±è¼¸ã€‚",
      init: (host, win) => {
        host.innerHTML = `
          <p class="h1">ä¸€äºŒä¸‰æœ¨é ­äºº</p>
          <p class="hint">ç¶ ç‡ˆï¼ˆGOï¼‰æ™‚å¯ä»¥é»æ“Š/å³æ»‘å‰é€²ï¼›ç´…ç‡ˆï¼ˆSTOPï¼‰æ™‚ç¢°åˆ°å°±è¼¸ã€‚åˆ°é” 100% å°±éé—œã€‚</p>
          <div class="signal">
            <div class="lamp go" id="lamp">GO</div>
            <div class="pill">å‰©é¤˜ï¼š<b id="t">35</b>s</div>
          </div>
          <div class="spacer"></div>
          <div class="track"><div class="bar" id="bar"></div></div>
          <div class="runner">
            <img src="${EGG_SRC}" alt="egg">
            <span>é»æ“Šå‰é€² / å³æ»‘å¤§æ­¥</span>
          </div>
          <div class="spacer"></div>
          <div class="arena" id="arena" style="height:52%">
            <div style="position:absolute; left:14px; top:14px; color:rgba(255,255,255,.70); font-weight:900;">ã€Œé¾œç‹ã€åœ¨çœ‹ä½ â€¦</div>
          </div>
          <div class="spacer"></div>
          <button class="btn primary" id="start">é–‹å§‹</button>
        `;
        const lamp = $("#lamp", host);
        const tEl = $("#t", host);
        const bar = $("#bar", host);
        const arena = $("#arena", host);
        const btn = $("#start", host);

        let running=false, startAt=0, raf=0;
        let state="go"; // go/stop
        let nextFlipAt=0;
        let progress=0;

        function setState(s){
          state=s;
          lamp.className = "lamp " + (s==="go" ? "go":"stop");
          lamp.textContent = s==="go" ? "GO" : "STOP";
        }

        function fail(){
          running=false; cancelAnimationFrame(raf);
          btn.textContent="å†è©¦ä¸€æ¬¡"; btn.disabled=false;
          setState("stop");
        }

        function advance(n){
          if(!running) return;
          if(state!=="go"){ fail(); return; }
          progress = Math.min(100, progress + n);
          bar.style.width = progress + "%";
          if(progress>=100){
            running=false; cancelAnimationFrame(raf);
            win();
          }
        }

        // controls
        arena.addEventListener("click", ()=> advance(6));
        bindSwipe(arena, ()=>{/* left swipe = ç…è»Š/ä¸å‹• */}, ()=> advance(12));

        function loop(){
          const now = performance.now();
          const left = Math.max(0, 35 - (now-startAt)/1000);
          tEl.textContent = left.toFixed(0);

          if(now >= nextFlipAt){
            // flip with random duration
            if(state==="go"){
              setState("stop");
              nextFlipAt = now + (700 + Math.random()*900);
            }else{
              setState("go");
              nextFlipAt = now + (900 + Math.random()*1300);
            }
          }

          if(left<=0){
            running=false; cancelAnimationFrame(raf);
            if(progress>=100) win();
            else { btn.textContent="å†è©¦ä¸€æ¬¡"; btn.disabled=false; }
            return;
          }
          raf = requestAnimationFrame(loop);
        }

        btn.addEventListener("click", ()=>{
          progress=0; bar.style.width="0%";
          btn.disabled=true; btn.textContent="é€²è¡Œä¸­â€¦ï¼ˆå°å¿ƒç´…ç‡ˆï¼‰";
          running=true; startAt=performance.now();
          setState("go");
          nextFlipAt = startAt + 1000;
          raf = requestAnimationFrame(loop);
        });
      }
    }
  ];

  function showMenu(){
    gameTitle.textContent = "å…­å¼µå¡ç‰‡ãƒ»å…­å€‹å°é—œå¡";
    gameDesc.textContent = "æƒæ QR Code é€²å…¥å°æ‡‰é—œå¡ã€‚å®Œæˆ 6 é—œå°±èƒ½è§£é–è›‹ç³•ã€‚";
    renderProgress();

    const doneCount = GAMES.reduce((a,g)=>a+(getDone(g.id)?1:0),0);

    root.innerHTML = `
      <p class="h1">çµ¦é˜¿ç™±çš„ç”Ÿæ—¥ä»»å‹™</p>
      <p class="hint">æ¯å¼µå¡ç‰‡æ˜¯ä¸€å€‹å°éŠæˆ²ï¼ˆé»æ“Šï¼†å·¦å³æ»‘å‹•ï¼‰ã€‚å…­é—œå…¨éï¼Œå»è›‹ç³•é æ”¶é©šå–œã€‚</p>
      <div class="spacer"></div>
      <div class="row">
        <span class="pill">ç›®å‰é€²åº¦ï¼š<b>${doneCount}</b>/6</span>
        <a class="btn primary" href="final.html">å‰å¾€è›‹ç³•é </a>
      </div>
      <div class="spacer"></div>
      <div class="row" style="flex-direction:column; align-items:stretch;">
        ${GAMES.map(g=>{
          const d = getDone(g.id);
          return `<a class="btn ${d?'':'primary'}" href="play.html?g=${g.id}">${d?'âœ…':'â–¶ï¸'} ${g.title}</a>`;
        }).join("")}
      </div>
      <div class="spacer"></div>
      <button class="btn danger" id="wipe">æ¸…é™¤é€²åº¦ï¼ˆæ¸¬è©¦ç”¨ï¼‰</button>
    `;
    $("#wipe", root).addEventListener("click", ()=>{ clearAll(); showMenu(); });
  }

  function showOverlay(gameId){
    renderProgress();
    $("#ovTitle").textContent = "å®Œæˆï¼ä½ æ‹¿åˆ°ä¸€ç‰‡è›‹ç³•ç¢ç‰‡";
    $("#ovDesc").textContent = "å»æƒä¸‹ä¸€å¼µå¡ï¼Œæˆ–æŒ‰ä¸‹ä¸€é—œç¹¼çºŒã€‚";
    overlay.classList.add("show");

    $("#btnBack").onclick = () => { overlay.classList.remove("show"); showMenu(); };
    $("#btnReset").onclick = () => { clearAll(); overlay.classList.remove("show"); showMenu(); };

    const nextId = gameId < 6 ? gameId+1 : 0;
    const btnNext = $("#btnNext");
    if(nextId){
      btnNext.textContent = "ä¸‹ä¸€é—œ";
      btnNext.onclick = () => location.href = `play.html?g=${nextId}`;
    }else{
      btnNext.textContent = "å»è›‹ç³•é ";
      btnNext.onclick = () => location.href = "final.html";
    }
  }

  function loadGame(id){
    const g = GAMES.find(x=>x.id===id);
    if(!g){ showMenu(); return; }

    gameTitle.textContent = g.title;
    gameDesc.textContent = g.desc;
    renderProgress();

    const win = () => { setDone(id); showOverlay(id); };
    g.init(root, win);
  }

  const url = new URL(location.href);
  const id = Number(url.searchParams.get("g") || "0");
  loadGame(id);
})();
</script>
</body>
</html>
